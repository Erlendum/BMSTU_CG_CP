\chapter{Аналитическая часть}

В данном разделе проводится анализ задачи построения трёхмерного изображения сцены, рассматриваются различные методы, решающие данную задачу.

\section{Описание модели трёхмерного объекта на сцене}

Модели могут задаваться следующими способами \cite{rodgers}:
\begin{enumerate}[label=\arabic*)]
	\item Каркасная (проволочная) модель. В этой модели задается информация о вершинах и рёбрах объектов. Это простейший вид моделей. Этим видам модели присущ недостаток:  нельзя отличить видимые грани от невидимых.
	\item Поверхностная модель. Поверхность может описываться аналитически, либо может задаваться другим способом. Недостаток: отсутствует информация о том, с какой стороны поверхности находится материал.
	\item Объёмная модель. Эта форма модели отличается от поверхностной тем, что в объёмных моделях к информации
	о поверхности добавляется информация о том, с какой стороны расположен материал.
\end{enumerate}

Для решения поставленной задачи не подойдёт проволочная модель, так как в этом случае нельзя будет отличить видимые грани от невидимых, что является существенным недостатком при построении реалистичного изображения. Поверхностная модель также не подойдёт, потому что для достижения поставленной цели курсовой работы необходимо знать, с какой стороны поверхности расположен материал. Таким образом, была выбрана объёмная модель.

\section{Описание способа задания трёхмерного объекта на сцене}

Существует несколько способов задания объёмной модели \cite{rodgers}:
\begin{enumerate}[label=\arabic*)]
	\item Аналитический способ. Этот способ характеризуется описанием объекта в неявной форме, то есть для получения визуального представления нужно вычислять значения некоторой функции в различных точках пространства.
	\item Полигональная сетка. Это совокупность вершин, рёбер и граней, которые определяют форму многогранного объекта в трёхмерной компьютерной графике и объёмном моделировании. Гранями обычно являются треугольники, так как любой полигон можно представить в виде треугольника.
	В свою очередь существуют различные способы хранения информации о полигональной сетке.
	\begin{enumerate}[label=\arabic*)]
		\item Список граней. Характеризуется множеством граней и множеством вершин. В каждую грань входят как минимум три вершины.
		\item <<Крылатое>> представление. Представляет вершины, грани и ребра сетки. Его основные недостатки -- дополнительные требования к объёму занимаемой памяти из-за содержания множества индексов и генерирование списка индексов граней.
		\item Вершинное представление. Описывает объект как множество вершин, соединенных с другими вершинами. Это простейшее представление, но оно не широко используемое, так как информация о гранях и ребрах не выражена явно. Поэтому нужно обойти все данные чтобы сгенерировать список граней для рендеринга.
	\end{enumerate}
\end{enumerate}

При выборе способа задания объекта в курсовой работе определяющим фактором стала скорость выполнения геометрических преобразований.

Оптимальное представление -- полигональная сетка. Такая модель позволит легко описывать сложные объекты сцены. 

Способом хранения информации о полигональной сетке был выбран список граней, потому что этот способ даёт явное описание граней, что позволяет  выполнять геометрические преобразования над объектами сцены без генерирования дополнительных списков, как в вершинном и <<крылатом>> представлениях.

\section{Формализация объектов сцены}

Сцена состоит из следующих объектов:
\begin{enumerate}[label=\arabic*)]
	\item Геометрический объект представляется в виде полигональной сетки. Для описания геометрического объекта требуется указать координаты вершин, связи вершин (рёбра), фоновое освещение (цвет), диффузное освещение (цвет), зеркальное освещение (цвет), коэффициент фонового освещения, коэффициент диффузного освещения, коэффициент зеркального освещения, степень, аппроксимирующая пространственное распределение зеркально отражённого света, коэффициент отражения, коэффициент преломления, показатель преломления.
	\item Источник света представляется в виде точечного объекта. К его характеристикам относятся расположение, цвет и интенсивность излучения.
	\item Камера характеризуется пространственным положением и направлением взгляда.
\end{enumerate}

\section{Анализ задачи построения трёхмерного изображения сцены из объектов}

Построение трёхмерного изображения сцены заключается в преобразовании объектов этой сцены
в изображение на растровом дисплее. Для создания реалистичного изображения необходимо учитывать несколько факторов.
\begin{enumerate}[label=\arabic*)]
	\item Удаление невидимых линий и поверхностей.
	\item Тени.
	\item Освещение.
	\item Свойства материалов объекта: способность отражать свет, способность преломлять свет.
\end{enumerate}

\subsection{Удаление невидимых линий и поверхностей}\label{choiceraytracing}

Задача удаления невидимых линий и поверхностей является одной из наиболее сложных в компьютерной графике \cite{rodgers}.
Алгоритмы удаления невидимых линий и поверхностей служат для определения линий ребер, поверхностей или объемов, которые видимы или невидимы для наблюдателя, находящегося в заданной точке пространства.

Алгоритмы удаления невидимых линий и поверхностей делятся на:
\begin{enumerate}[label=\arabic*)]
	\item Алгоритмы, работающие в объектном пространстве (мировая система координат, высокая точность).
	\item Алгоритмы, работающие в пространстве изображений (система координат связана с дисплеем, точность ограничена разрешающей способностью дисплея).
\end{enumerate}
Рассмотрим алгоритмы удаления невидимых линий и поверхностей.

\subsubsection{Алгоритм Робертса}

Данный алгоритм работает в объектном пространстве, решая задачу только с выпуклыми телами \cite{rodgers}.

Алгоритм выполняется в три этапа.

\begin{enumerate}[label=\arabic*)]
	\item Этап подготовки исходных данных.
	На данном этапе задана информация о телах. Для каждого тела сцены сформирована матрица тела $V$. Размерность матрицы -- $4n$, где $n$ -- количество граней тела.
	
	Каждый столбец матрицы представляет собой четыре коэффициента уравнения плоскости, проходящей через очередную грань:
	\begin{equation}
		\label{eqpolygone}
		ax + by + cz + d = 0.
	\end{equation}
	
	Таким образом, матрица тела будет представлена в следующем виде:
	
	\begin{equation}
		V = \begin{pmatrix}
			a_{1} & a_{2} & \ldots & a_{n}\\
			b_{1} & b_{2} & \ldots & b_{n}\\
			c_{1} & c_{2} & \ldots & c_{n}\\
			d_{1} & d_{2} & \ldots & d_{n}
		\end{pmatrix}.
	\end{equation}
	
	Матрица тела сформирована корректно, то есть любая точка, расположенная внутри тела, должна располагаться по положительную сторону от каждой грани тела. В случае, если для очередной грани условие не выполняется, соответствующий столбец матрицы надо умножить на $-1$. 
	
	\item Этап удаления ребер, экранируемых самим телом.
	На данном этапе рассматривается вектор взгляда $E = \{0, 0, -1, 0\}^T$.
	Для определения невидимых граней нужно умножить вектор $E$ на матрицу тела $V$. Отрицательные компоненты полученного вектора будут соответствовать невидимым граням.

	\item Этап удаления невидимых ребер, экранируемых другими телами сцены.
	На данном этапе для определения невидимых точек ребра требуется построить луч, соединяющий точку наблюдения с точкой на ребре. Точка будет невидимой, если луч на своем пути встречает в качестве преграды рассматриваемое тело. Если тело является преградой, то луч должен пройти через тело. Если луч проходит через тело, то он находится по положительную сторону от каждой грани тела.
\end{enumerate}

Свойства алгоритма Робертса:
\begin{enumerate}[label=\arabic*)]
	\item алгоритм работает в объектном пространстве, точность вычислений высокая;
	\item теоретический рост сложности алгоритма -- квадрат числа объектов;
	\item все тела сцены должны быть выпуклыми. 
\end{enumerate}

Алгоритм Робертса не подходит для решения поставленной задачи по следующим причинам.

\begin{enumerate}[label=\arabic*)]
	\item Возникновение проблем при наличии невыпуклых тел на сцене.
	\item Невозможность визуализации зеркальных поверхностей.
\end{enumerate}

\subsubsection{Алгоритм, использующий $z$-буфер}

Данный алгоритм работает в пространстве изображения \cite{rodgers}. Используется два буфера:
	буфер кадра, в котором хранятся атрибуты каждого пикселя в пространстве изображения и $z$-буфер, куда помещается информация о координате $z$ для каждого пикселя.

Алгоритм выполняется в несколько этапов.

\begin{enumerate}[label=\arabic*)]
	\item  Первоначально в $z$-буфере находятся минимально возможные значения $z$, а в буфере кадра располагаются пиксели, описывающие фон. 
	\item Каждый многоугольник преобразуется в растровую форму и записывается в буфер кадра.
	\item В процессе подсчета глубины нового пикселя, он сравнивается с тем значением, которое уже лежит в $z$-буфере. Если новый пиксель расположен ближе к наблюдателю, чем предыдущий, то он заносится в буфер кадра и происходит корректировка $z$-буфера.
	\item  Для решения задачи вычисления глубины $z$ каждый многоугольник описывается уравнением $ax + by + cz + d = 0$. При $c = 0$ многоугольник для наблюдателя вырождается в линию. 
	
	Для решения задачи вычисления глубины $z$ каждый многоугольник описывается уравнением 
	\begin{equation}
			ax + by + cz + d = 0.
	\end{equation}

	При $c = 0$ многоугольник для наблюдателя вырождается в линию. 
	
	Для некоторой сканирующей строки $y = const$, поэтому имеется возможность рекуррентно высчитывать $z^\prime$ для каждого $x^\prime = x + dx$:
	
	\begin{equation}
		z^\prime - z = -\frac{ax^\prime + d}{c} +\frac{ax + d}{c} = \frac{a(x - x^\prime)}{c}
	\end{equation}

Получим: $z^\prime = z - \frac{a}{c^\prime}$, так как $x - x^\prime = dx = 1$.

	\item Для невыпуклых многогранников предварительно потребуется удалить нелицевые грани.
\end{enumerate}

Свойства алгоритма, использующего $z$-буфер:
\begin{enumerate}[label=\arabic*)]
	\item алгоритм имеет линейную сложность.
	\item большой объём требуемой памяти (два буфера размером $n \cdot m$, где $n$ -- количество пикселей растра в горизонтальном измерении, $m$ -- количество пикселей растра в вертикальном измерении);
	\item реализация эффектов прозрачности сложна;
	\item реализация эффектов зеркальности невозможна;
	\item дополнительные вычислительные операции в случае невыпуклых тел.
\end{enumerate}

Алгоритм, использующий $z$-буфер не подходит для решения поставленной задачи по следующим причинам.

\begin{enumerate}[label=\arabic*)]
	\item Сложность визуализации прозрачных поверхностей.
	\item Невозможность визуализации зеркальных поверхностей.
\end{enumerate}

\subsubsection{Алгоритм обратной трассировки лучей}

Главная идея, лежащая в основе алгоритма трассировки лучей, заключается в том, что наблюдатель видит любой объект посредством испускаемого луча неким источником света, который падает на этот объект и затем каким-то путём доходит до наблюдателя. Свет может достичь наблюдатель, отразившись от поверхности, преломившись или пройдя через неё. Если проследить за лучами света, выпущенными источниками, то можно убедиться, что весьма немногие из них дойдут до наблюдателя. Следовательно, этот процесс был бы вычислительно неэффективным. Аппель первым предложил отслеживать (трассировать) лучи в обратном направлении, т.~е. от наблюдателя к объекту \cite{rodgers}.

Агоритм выполняется в несколько этапов.

\begin{enumerate}[label=\arabic*)]
	\item Сцена преобразовывается в пространство изображения. Перспективное преобразование не используется. Считается, что точка зрения или наблюдатель находится в бесконечности на положительной полуоси $z$. Поэтому все световые лучи параллельны оси $z$. 
	\item Каждый луч, исходящий от наблюдателя, проходит через центр пикселя на растре до сцены.
	\item Необходимо проверить пересечение каждого объекта сцены с каждым лучом.
	\item Если луч пересекает объект, то определяются все возможные точки пересечения луча и объекта. Эти пересечения упорядочиваются по глубине.
	\item Пересечение с максимальным значением глубины представляет видимую поверхность для данного пикселя. Свойства материала этого объекта используются для определения характеристик пикселя.
	\item Если материал объекта обладает отражающими и/или преломляющими свойствами, то луч рекурсивно отражается и/или преломляется.
	\item Для учёта теней испускается луч из точки пересечения с объектом к источнику света.
	\item Если данный луч пересекает какой-либо объект сцены, то точка пересечения первичного луча с объектом считается теневой.
	\item Если точка зрения находится не в бесконечности, строится одноточечная центральная проекция на картинную плоскость.
\end{enumerate}


Свойства алгоритма обратной трассировки лучей:
\begin{enumerate}[label=\arabic*)]
	\item высокая реалистичность синтезируемого изображения;
	\item реализация алгоритма предполагает учёт теней;
	\item простота визуализации зеркальных и прозрачных поверхностей.
	\item время выполнения рендеринга изображения, по сравнению с алгоритмом Робертса и алгоритмом, использующего $z$-буфер, увеличивается из-за рекурсивных погружений.
\end{enumerate}

\subsubsection{Вывод}

Таким образом, в качестве алгоритма удаления невидимых рёбер и поверхностей был выбран алгоритм обратной трассировки лучей из-за высокой реалистичности синтезируемого изображения и возможности визуализации зеркальных и прозрачных поверхностей.

\subsection{Учёт теней}

При использовании алгоритма обратной трассировки лучей, выбранного в качестве алгоритма удаления невидимых рёбер и поверхностей в главе \ref{choiceraytracing}, построение теней происходит по ходу выполнения алгоритма: пиксель будет затемнён, если луч испускаемый из точки попадания первичного луча, испускаемого из камеры, попадает на другой объект.

\subsection{Учёт освещения}

Модель освещения предназначена для того, чтобы рассчитать интенсивность отражённого к наблюдателю света в каждой точке (пикселе) изображения \cite{rodgers}.  Глобальная модель учитывает не только свет и ориентацию поверхностей, но также и свет, отражённый от других объектов (или пропущенный через них) Благодаря этому глобальная модель освещённости способна воспроизводить эффекты зеркального отражения и преломления лучей (прозрачность и полупрозрачность), а также затенение, что является необходимым для решения поставленной в курсовой работе задачи. Глобальная модель является составной частью алгоритма удаления невидимых рёбер и поверхностей с помощью обратной трассировки лучей.

Глобальная модель освещения для каждого пикселя изображения определяет его интенсивность. Сначала определяется непосредственная освещённость источниками без учёта отражений от других поверхностей (вторичная освещённость): отслеживаются лучи, направленные ко всем источникам. Тогда наблюдаемая интенсивность (или отражённая точкой энергия) выражается следующим соотношением:

\begin{equation}
	I = k_0I_0 + k_d\sum\limits_{j}^{}I_j(n \cdot l_j) + k_r\sum\limits_{j}^{}I_j(s \cdot r_j)^{\beta}+k_rI_r+k_tI_t,
\end{equation}
где

$k_0$ -- коэффициент фонового освещения,

$k_d$ -- коэффициент диффузного отражения,

$k_r$ -- коэффициент зеркального отражения,

$k_t$ -- коэффициент пропускания,

$n$ -- единичный вектор нормали к поверхности в точке,

$l_j$ -- единичный вектор, направленный к $j$-му источнику света,

$s$ -- единичный локальный вектор, направленный в точку наблюдения,

$r_j$ -- отражённый вектор $l_j$,

$I_0$ -- интенсивность фонового освещения,

$I_j$ -- интенсивность $j$-го источника света,

$I_r$ --  интенсивность, приходящая по зеркально отражённому лучу,

$I_t$ -- интенсивность, приходящая по преломлённому лучу.

\section{Выводы из аналитической части}
Были рассмотрены способы задания трёхмерных моделей и выбрана объёмная форма задания моделей.

Также были рассмотрены алгоритмы удаления невидимых рёбер и поверхностей:
\begin{enumerate}[label=\arabic*)]
	\item алгоритм Робертса;
	\item алгоритм, использующий z-буфер;
	\item алгоритм обратной трассировки лучей.
\end{enumerate}
В качестве  алгоритма удаления невидимых рёбер и поверхностей был выбран алгоритм обратной трассировки лучей с глобальной моделью освещения из-за высокой реалистичности синтезируемого изображения и возможности визуализации зеркальных и прозрачных поверхностей.
 
